{% set title = room.name %}
{% extends "layout.html" %}
{% block content %}

<div class="chat" id="messages">
</div>

{% if not current_user.is_anonymous %}
<form method="POST" autocomplete="off" action="{{ url_for('send_message', room_id=message_form.room_id.data) }}">
	{% for field in message_form %}
		{{ field.label if not field.flags.hidden }} {{ field }}<br>
	{% endfor %}
	<input tabindex="0" type="submit">
</form>
{% else %}
<p>Please login <a href="{{ url_for('login') }}">here</a> to send messages!</p>
{% endif %}

<script>

	function getMessages() {
		fetch('/get_messages/{{ message_form.room_id.data }}')
			.then(response => response.json())
			.then(messages => {
				let messageList = ""
				for (let i = 0; i < messages.length; i++) {
					let sender = messages[i].sender;
					let content = messages[i].content;
					let sent_time = messages[i].sent_time;
					messageList += /* man i hate javascript */
						"<p><b>" + sent_time + " " + "<a href='/user/" + sender + "'>" + sender + "</a>" + ": </b>" + content + "</p>"
				}
				document.getElementById("messages").innerHTML = messageList
				var objDiv = document.getElementById("messages");
				objDiv.scrollTop = objDiv.scrollHeight;
			});
	}

	{# https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event #}
	window.addEventListener('load', (event) => {
		getMessages();
	});


	{# https://www.codegrepper.com/code-examples/javascript/javascript+request+every+second #}
	setInterval(getMessages, 5000 /* milliseconds */ );
</script>

{% endblock content %}